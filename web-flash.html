<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootloader Flash Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Bootloader Flash Tool</h1>
        <div class="card mt-4">
            <div class="card-body">
                <form id="flashForm">
                    <div class="mb-3">
                        <label for="binFile" class="form-label">Upload .bin File</label>
                        <input type="file" class="form-control" id="binFile" accept=".bin" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Flash Firmware</button>
                </form>
                <div id="status" class="mt-3 text-center"></div>
            </div>
        </div>
    </div>

    <script>
        let device;

        document.getElementById('flashForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const fileInput = document.getElementById('binFile');
            const statusDiv = document.getElementById('status');

            if (!fileInput.files.length) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Please select a .bin file.</div>';
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = async (e) => {
                const binData = new Uint8Array(e.target.result);

                try {
                    statusDiv.innerHTML = '<div class="alert alert-info">Connecting to device...</div>';
                    await connectToDevice();

                    statusDiv.innerHTML = '<div class="alert alert-info">Initializing device...</div>';
                    let response = await sendCommand(0x07); // CMD_INIT
                    if(response[0] !== 0x37) {
                        statusDiv.innerHTML = '<div class="alert alert-danger">Device not in bootloader mode.</div>';
                        console.error('Device not in bootloader mode. Response:', response[0].toString(16));
                        return;
                    } else {
                        console.log('Device in bootloader mode, proceeding...');
                    }

                    statusDiv.innerHTML = '<div class="alert alert-info">Flashing firmware...</div>';
                    response = await sendCommand(0x01); // CMD_ERASE
                    if(response[0] !== 0x00) {
                        statusDiv.innerHTML = '<div class="alert alert-danger">Erase command failed.</div>';
                        console.error('Erase command failed. Response:', response[0].toString(16));
                        return;
                    } else {
                        console.log('Erase command successful, proceeding to flash...');
                    }

                    await sendBinData(binData);

                    response = await sendCommand(0x04); // CMD_END
                    if(response[0] !== 0xBE) {
                        statusDiv.innerHTML = '<div class="alert alert-danger">End command failed.</div>';
                        console.error('End command failed. Response:', response[0].toString(16));
                        return;
                    } else {
                        console.log('End command successful, proceeding to verify...');
                    }

                    statusDiv.innerHTML = '<div class="alert alert-success">Firmware flashed successfully. Verifying...</div>';
                    const verifySuccess = await verifyFirmware(binData);

                    if (verifySuccess) {
                        statusDiv.innerHTML = '<div class="alert alert-success">Verification successful. Resetting MCU...</div>';
                        await sendCommand(0x05); // CMD_JUMP
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-danger">Verification failed.</div>';
                    }
                } catch (error) {
                    console.error(error);
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                }
            };

            reader.readAsArrayBuffer(file);
        });

        async function connectToDevice() {
            if(device !== undefined) return; // Already connected
            const filters = [{ vendorId: 0x1209, productId: 0xD035 }]; // Replace with actual VID/PID
            device = await navigator.hid.requestDevice({ filters });
            if (!device) throw new Error('No device selected.');
            device = device[0]; // Select the first device
            await device.open();
        }

        async function sendCommand(command, payload = undefined) {
            const reportId = 0xaa; // Report ID used in the bootloader
            const data = new Uint8Array(255); // Length = 255
            data[0] = payload ? payload.length : 0; // Length (data + command byte)
            data[1] = command; // Command
            if(payload) data.set(payload, 2); // Data starts at index 2
            await device.sendFeatureReport(reportId, data);

            const response = await receiveResponse();
            //if (response[0] !== 0x00) throw new Error(`Command failed with status: ${response[0]}`);

            return response; // Return the response for further processing if needed
        }

        async function sendBinData(binData) {
            const reportId = 0xaa; // Report ID used in the bootloader
            const maxDataLength = 64; // Maximum data length per block

            console.log('Starting to send binary data...');
            for (let offset = 0; offset < binData.length; offset += maxDataLength) {
                const isLastBlock = offset + maxDataLength >= binData.length;
                const command = isLastBlock ? 0x06 : 0x02; // CMD_WRITE_LAST or CMD_WRITE
                const chunk = binData.slice(offset, offset + maxDataLength);

                console.log(`Sending block: offset=${offset}, length=${chunk.length}, command=${command.toString(16)}`);
                const payload = new Uint8Array(255); // 255-byte buffer
                payload[0] = chunk.length; // Length (data + command byte)
                payload[1] = command; // Command
                payload.set(chunk, 2); // Data starts at index 2

                await device.sendFeatureReport(reportId, payload);

                const response = await receiveResponse();
                if (response[0] !== 0x00) {
                    console.error(`Write failed at offset=${offset} with status: ${response[0]}`);
                    throw new Error(`Write failed with status: ${response[0]}`);
                }
                console.log(`Block sent successfully: offset=${offset}`);
            }
            console.log('Binary data sent successfully.');
        }

        async function verifyFirmware(binData) {
            console.log('Starting firmware verification...');
            const reportId = 0xaa; // Report ID used in the bootloader
            const maxDataLength = 64; // Maximum data length per block

            for (let offset = 0; offset < binData.length; offset += maxDataLength) {
                const chunk = binData.slice(offset, offset + maxDataLength);
                console.log(`Verifying block: offset=${offset}, length=${chunk.length}`);
                const payload = new Uint8Array(255); // 255-byte buffer
                payload[0] = chunk.length; // Length (data + command byte)
                payload[1] = 0x03; // CMD_VERIFY
                payload.set(chunk, 2); // Data starts at index 2

                await device.sendFeatureReport(reportId, payload);

                const response = await receiveResponse();
                if (response[0] !== 0x00) {
                    console.error(`Verification failed at offset=${offset} with status: ${response[0]}`);
                    return false; // Verification failed
                }
                console.log(`Block verified successfully: offset=${offset}`);
            }
            console.log('Firmware verification completed successfully.');
            return true; // Verification successful
        }

        async function receiveResponse() {
            const reportId = 0xaa; // Report ID used in the bootloader
            let retries = 10;
            while (retries--) {
                const response = await device.receiveFeatureReport(reportId);
                if (response.byteLength > 0) return new Uint8Array(response.buffer);
                await new Promise((resolve) => setTimeout(resolve, 500)); // Retry delay
            }
            throw new Error('No response from device.');
        }

        function parseHexLine(line) {
            // Parse a single line of Intel HEX format
            // This is a placeholder; implement actual parsing logic
            return new Uint8Array(line.trim().split('').map((char) => char.charCodeAt(0)));
        }
    </script>
</body>
</html>
